<a name="inicio"></a>

# üìò **THE CURE PROJECT** üßë‚ÄçüíªüöÄ

# Servicio de Audio y V√≠deo para InnovateTech

---

## Introducci√≥n

El servicio de audio y v√≠deo bajo demanda (AOD/VOD) de InnovateTech es un componente cr√≠tico de su plataforma web. Este apartado detalla la implementaci√≥n de un sistema de streaming basado en RTMP para audio y NGINX con el m√≥dulo RTMP/HLS para v√≠deo, utilizando FFmpeg como herramienta de codificaci√≥n y transmisi√≥n. La soluci√≥n est√° optimizada para garantizar eficiencia, escalabilidad y sostenibilidad.

El sistema se prob√≥ inicialmente en un entorno local en una m√°quina Ubuntu, utilizando flujos de audio y v√≠deo enviados a trav√©s de FFmpeg a un servidor Icecast y, posteriormente, integrados con NGINX para streaming HLS. Se desarrollaron scripts de automatizaci√≥n y servicios systemd para garantizar un funcionamiento eficiente y sostenible, con mecanismos de apagado autom√°tico para minimizar el consumo energ√©tico cuando no hay usuarios conectados.


## Implementaci√≥n del Servicio de Audio

### Configuraci√≥n de Icecast para Streaming de Audio

Se configur√≥ un servidor Icecast en una m√°quina Ubuntu (ip-172-31-85-195) para gestionar el streaming de audio en formato MP3. La configuraci√≥n inicial permite pruebas locales, con el flujo enviado desde FFmpeg a un punto de montaje en 

**icecast://source:sjo@localhost:8000/stream** 

El servidor temprano soporta hasta 20 oyentes simult√°neos, con medidas de seguridad como autenticaci√≥n de fuente y oyentes.
El archivo de configuraci√≥n de Icecast se optimiz√≥ para garantizar un equilibrio entre rendimiento y consumo de recursos, habilitando el soporte CORS para permitir la integraci√≥n con reproductores web.

**Comando FFmpeg para Audio**:

```ini
ffmpeg -re -i "01. Main Theme.mp3" -vn -c:a libmp3lame -b:a 128k -f mp3 
icecast://source:sjo@localhost:8000/stream
```

**Configuraci√≥n de Icecast**:

```ini
<icecast>
    <!-- General server info -->
    <location>Earth</location>
    <admin>admin@innovatetech.com</admin>

    <!-- Connection and streaming limits -->
    <limits>
        <clients>20</clients>
        <sources>1</sources>
        <queue-size>524288</queue-size>
        <client-timeout>30</client-timeout>
        <header-timeout>15</header-timeout>
        <source-timeout>10</source-timeout>
        <burst-on-connect>1</burst-on-connect>
        <burst-size>65535</burst-size>
    </limits>

    <!-- Authentication -->
    <authentication>
        <source-password>sjo</source-password>
        <relay-password>sjo</relay-password>
        <admin-user>admin</admin-user>
        <admin-password>sjo</admin-password>
    </authentication>

    <!-- Public server hostname -->
    <hostname>innovatetech.com</hostname>

    <!-- Socket configuration -->
    <listen-socket>
        <port>8000</port>
    </listen-socket>

    <!-- CORS support -->
    <http-headers>
        <header name="Access-Control-Allow-Origin" value="*" />
    </http-headers>

    <!-- Mountpoint configuration -->
    <mount type="normal">
        <mount-name>/innovate.mp3</mount-name>
        <public>1</public>
        <max-listeners>20</max-listeners>
        <authentication type="htpasswd">
            <option name="filename" value="/etc/icecast2/passwd" />
            <option name="allow_duplicate_users" value="0" />
        </authentication>
    </mount>

    <!-- File serving -->
    <fileserve>1</fileserve>

    <paths>
        <basedir>/usr/share/icecast2</basedir>
        <logdir>/var/log/icecast2</logdir>
        <webroot>/usr/share/icecast2/web</webroot>
        <adminroot>/usr/share/icecast2/admin</adminroot>
        <alias source="/" destination="/status.xsl"/>
    </paths>

    <!-- Logging -->
    <logging>
        <accesslog>access.log</accesslog>
        <errorlog>error.log</errorlog>
        <loglevel>2</loglevel>
        <logsize>10000</logsize>
    </logging>

    <!-- Security -->
    <security>
        <chroot>0</chroot>
    </security>
</icecast>
```

**Pruebas de Streaming de Audio**:

Se realizaron pruebas enviando un archivo MP3 (15. Toad House.mp3) a un punto de montaje alternativo (/live.mp3) usando el c√≥dec AAC para mayor eficiencia:

```ini
ffmpeg -re -i "15. Toad House.mp3" -vn -c:a aac -b:a 128k -f flv
rtmp://34.204.241.226:1935/live/stream

```

El flujo era accesible en http://13.219.197.73:8000/live.mp3.

### Scripts de Automatizaci√≥n

Se desarrollaron scripts para gestionar el streaming de audio como un servicio, con se√±ales de "ping" para detener la transmisi√≥n cuando no hay oyentes, reduciendo el consumo energ√©tico. Estos scripts se integraron en un servicio systemd (player-loop.service) para garantizar un funcionamiento continuo y automatizado, el mismo se conect√≥ m√°s tarde con el servidor Nginx para darle un frontend web, aunque no se ped√≠a, esto lo hicimos para realizar una implementaci√≥n m√°s realista y darle un uso a la p√°gina web.

## Implementaci√≥n del Servicio de V√≠deo

### Configuraci√≥n de NGINX con M√≥dulo RTMP/HLS

Para el streaming de v√≠deo/audio, se compil√≥ una versi√≥n personalizada de NGINX (versi√≥n 1.24.0) con soporte para el m√≥dulo RTMP y HLS, permitiendo la distribuci√≥n del contenido en formato adaptativo. El servidor se configur√≥ para servir contenido desde /var/www/html, con archivos como index.html para la interfaz web y hls para los segmentos de audio/video. Adem√°s se configur√≥ el socket de PHP por problemas de incompatibilidad.

**Comando FFmpeg para V√≠deo**:

```ini

ffmpeg -re -stream_loop -1 -i /home/ubuntu/video/walle.mp4 -c:v libx264 -preset veryfast -maxrate 1000k -bufsize 2000k -g 50 -c:a aac -b:a 128k -ar 44100 -ac 2 -f flv rtmp://innovatetech.duckdns.org/live/stream

```

Configuraci√≥n HLS:
Se implement√≥ HLS para streaming adaptativo, generando segmentos de 4 segundos con una lista de reproducci√≥n de 5 segmentos, eliminando segmentos antiguos para optimizar el almacenamiento:

```ini
ffmpeg -re -i video.mp4 -c:v libx264 -preset veryfast -tune zerolatency -c:a aac -f hls -hls_time 4 -hls_list_size 5 -hls_flags delete_segments ~/hls_output/index.m3u8
```
A continuaci√≥n, presento la secci√≥n completa y revisada que incluye el **Comando FFmpeg para V√≠deo**, la **Configuraci√≥n HLS** y la nueva informaci√≥n sobre los scripts de automatizaci√≥n (player-loop.sh y player-video-loop.sh) para el servicio de streaming de InnovateTech. Todo est√° integrado en un solo texto en espa√±ol, manteniendo un tono t√©cnico, profesional y claro, con un estilo pulido y alineado con los objetivos de sostenibilidad y eficiencia del proyecto. Los scripts se incluyen como artefactos dentro de etiquetas <xaiArtifact>, y se describen sus funciones destacando su contribuci√≥n a la escalabilidad y sostenibilidad. La informaci√≥n se presenta sin omitir nada, siguiendo la estructura solicitada y respetando las directrices proporcionadas.

**Comando FFmpeg para V√≠deo**:

```ini
ffmpeg -re -stream_loop -1 -i /home/ubuntu/video/walle.mp4 -c:v libx264 -preset veryfast -maxrate 1000k -bufsize 2000k -g 50 -c:a aac -b:a 128k -ar 44100 -ac 2 -f flv rtmp://innovatetech.duckdns.org/live/stream
```

**Configuraci√≥n HLS**:

Se implement√≥ HLS para streaming adaptativo, generando segmentos de 4 segundos con una lista de reproducci√≥n de 5 segmentos, eliminando segmentos antiguos para optimizar el almacenamiento:

```ini
ffmpeg -re -i video.mp4 -c:v libx264 -preset veryfast -tune zerolatency -c:a aac -f hls -hls_time 4 -hls_list_size 5 -hls_flags delete_segments ~/hls_output/index.m3u8
```

**Scripts de Automatizaci√≥n para Streaming de Audio y V√≠deo**:

Para garantizar un funcionamiento eficiente y sostenible, se desarrollaron dos scripts en Bash (player-loop.sh para audio y player-video-loop.sh para v√≠deo) que automatizan el proceso de streaming.

### Automatizaci√≥n de Streaming de Audio (player-loop.sh)

El script player-loop.sh gestiona el streaming de audio mediante las siguientes funciones:

- Selecciona aleatoriamente archivos de audio desde el directorio /home/ubuntu/music y los transmite al URL RTMP rtmp://34.204.241.226:1935/live/stream usando FFmpeg con el c√≥dec AAC a 128 kbps.
- Verifica la presencia de espectadores cada 2 segundos mediante SSH a un servidor secundario (ec2-34-204-241-226.compute-1.amazonaws.com), leyendo el archivo /tmp/last_ping para determinar si hay usuarios conectados.
- Extrae metadatos (t√≠tulo y artista) de los archivos de audio usando ffprobe y los env√≠a como JSON al servidor secundario (/tmp/current_song.json) para mostrarlos en la interfaz web.
- Implementa un tiempo de inactividad de 5 minutos (300 segundos), deteniendo el stream y finalizando el proceso si no hay espectadores, reduciendo as√≠ el consumo energ√©tico.
- Permite saltar manualmente a la siguiente canci√≥n verificando la existencia del archivo /tmp/next_song, que termina el proceso FFmpeg actual.

**Script: player-loop.sh**

```ini
#!/bin/bash

MUSIC_DIR="/home/ubuntu/music"
RTMP_URL="rtmp://34.204.241.226:1935/live/stream"

# Comunicaci√≥n con servidor B
KEY_PATH="/home/ubuntu/scripts/innovatech-key.pem"
USER_B="ubuntu"
HOST_B="ec2-34-204-241-226.compute-1.amazonaws.com"
DEST_PATH="/tmp/current_song.json"

# Tiempo m√°ximo sin viewers antes de apagar (en segundos)
INACTIVITY_TIMEOUT=300  # 5 minutos

check_web_viewers() {
  local LAST_PING=$(ssh -i "$KEY_PATH" -o StrictHostKeyChecking=no "$USER_B@$HOST_B" 'cat /tmp/last_ping 2>/dev/null || echo 0')
  local NOW=$(date +%s)
  local DIFF=$((NOW - LAST_PING))
  if [ "$DIFF" -lt 30 ]; then
    echo 1
  else
    echo 0
  fi
}

while true; do
  echo "‚è≥ Esperando espectadores web..."
  last_viewer_time=$(date +%s)

  while true; do
    VIEWERS=$(check_web_viewers)
    echo "üëÄ Viewers conectados: $VIEWERS"

    if [ "$VIEWERS" -gt 0 ]; then
      break  # Empezar a reproducir
    fi

    current_time=$(date +%s)
    diff=$((current_time - last_viewer_time))
    if [ "$diff" -ge "$INACTIVITY_TIMEOUT" ]; then
      echo "üõë Sin viewers por $INACTIVITY_TIMEOUT segundos. Apagando para ahorrar energ√≠a."
      exit 0
    fi

    sleep 3
  done

  echo "üéµ Comenzando reproducci√≥n porque hay espectadores."

  mapfile -t SONGS < <(find "$MUSIC_DIR" -type f | shuf)

  for SONG in "${SONGS[@]}"; do
    VIEWERS=$(check_web_viewers)
    if [ "$VIEWERS" -eq 0 ]; then
      echo "üö´ Nadie conectado. Parando reproducci√≥n y regresando al modo espera."
      break
    fi

    echo "‚ñ∂Ô∏è Reproduciendo: $SONG"

    METADATA=$(ffprobe -v quiet -show_entries format_tags=title,artist -of json "$SONG")
    TITLE=$(echo "$METADATA" | jq -r '.format.tags.title // "Desconocido"')
    ARTIST=$(echo "$METADATA" | jq -r '.format.tags.artist // "Desconocido"')

    echo "{\"title\": \"$TITLE\", \"artist\": \"$ARTIST\"}" > /tmp/current_song.json
    scp -i "$KEY_PATH" -o StrictHostKeyChecking=no /tmp/current_song.json "$USER_B@$HOST_B:$DEST_PATH"

    ffmpeg -re -i "$SONG" -vn -c:a aac -b:a 128k -f flv "$RTMP_URL" &
    FFMPEG_PID=$!

    while kill -0 $FFMPEG_PID 2>/dev/null; do
      if [ -f /tmp/next_song ]; then
        echo "‚è≠Ô∏è Siguiente solicitado, matando FFmpeg..."
        kill -9 $FFMPEG_PID
        rm -f /tmp/next_song
        break
      fi

      VIEWERS=$(check_web_viewers)
      if [ "$VIEWERS" -eq 0 ]; then
        echo "üõë Nadie conectado. Deteniendo reproducci√≥n."
        kill -9 $FFMPEG_PID
        break
      fi

      sleep 2
    done

    sleep 2
  done

  last_viewer_time=$(date +%s)
done
```

### Automatizaci√≥n de Streaming de V√≠deo (player-video-loop.sh)

El script player-video-loop.sh gestiona el streaming de v√≠deo mediante las siguientes funciones:



---

[**‚¨ÜÔ∏è Volver al inicio**](#inicio)
